# Knative + CoCo + Attestation

In this demo, we set up CoCo to attest the guest VM that is bootstrapped.
In order to run a functional attested system we need a service that, given
a launch digest, returns a secret (i.e. a relying party). We use CoCo's
[simple KBS](https://github.com/confidential-containers/simple-kbs).

For demonstration purposes, the simple KBS runs as a process in the same
node (outside Knative, and Kubernetes for that same reason). To start it,
just run:

```bash
inv kbs.start
```

Before running the application, we need to generate the expected launch digest
for our confidential VM. This launch digest will be generated by reading some
of the fields in the Kata config file, so we must update it before generating
the digest.

First, we need to set `guest_pre_attestation` so that the Kata Shim opens a
secure channel between the PSP and the KBS at boot time. We will later use this
hannel to validate firmware and software measurements from inside the guest:

```bash
inv coco.guest-attestation --mode on
```

note that this method also sets the right KBS URI, as the default one
(`localhost`) is not reachable from inside the guest.

Now, we must also enable signature verification. Signature verification is the
only method available in `v0.7.0` to check the launch digest against a user-
provided digest:

```bash
inv coco.signature-verification --mode on
```

In order to validate the launch digest, we need to pre-provision the launch
digest. To do so you may run:

```bash
inv kbs.provision-launch-digest
```

this method will generate launch digests from the data in the Kata configuration
files (i.e. `/opt/confidential-containers/share/defaults/kata-containers/configuration-*.toml`
if installed by the operator), and include them in the KBS.

Once the KBS has been populated with the right launch measurements, we can
deploy the workload just like with the `Hello world! (Knative)` app:

```bash
kubectl apply -f ./apps/helloworld-knative
```
